<div class="container mt-4">
  <h2>Buchsuche</h2>
  <hr />

  <div class="card bg-light mb-4 suche-form-card">
    <div class="card-body">
      <form [formGroup]="suchFormular" (ngSubmit)="suchen()">
        <div class="row g-3">
          <div class="col-12 col-md-6 col-xl-4">
            <label class="form-label">Titel</label>
            <input
              type="text"
              formControlName="titel"
              class="form-control"
              placeholder="Nach Titel suchen..."
            />
          </div>
          <div class="col-12 col-md-6 col-xl-4">
            <label class="form-label">ISBN</label>
            <input
              type="text"
              formControlName="isbn"
              class="form-control"
              placeholder="ISBN-Nummer..."
            />
          </div>
          <div class="col-12 col-md-6 col-xl-4">
            <label class="form-label">Schlagwörter</label>
            <input
              type="text"
              formControlName="schlagwoerter"
              class="form-control"
              placeholder="Schlagwörter..."
            />
          </div>
          <div class="col-12 col-md-6 col-xl-4">
            <label class="form-label">Art</label>
            <div class="btn-group" ngbDropdown container="body">
              <button
                type="button"
                class="btn btn-outline-secondary dropdown-toggle"
                id="dropdownArt"
                ngbDropdownToggle
              >
                {{ suchFormular.get('art')?.value || 'ALLE' }}
              </button>
              <div ngbDropdownMenu aria-labelledby="dropdownArt">
                <button
                  ngbDropdownItem
                  type="button"
                  (click)="suchFormular.get('art')?.setValue('ALLE')"
                >
                  ALLE
                </button>
                <button
                  ngbDropdownItem
                  type="button"
                  (click)="suchFormular.get('art')?.setValue('HARDCOVER')"
                >
                  HARDCOVER
                </button>
                <button
                  ngbDropdownItem
                  type="button"
                  (click)="suchFormular.get('art')?.setValue('PAPERBACK')"
                >
                  PAPERBACK
                </button>
                <button
                  ngbDropdownItem
                  type="button"
                  (click)="suchFormular.get('art')?.setValue('EPUB')"
                >
                  EPUB
                </button>
              </div>
            </div>
          </div>
          <div class="col-12 col-xl-8">
            <label class="form-label">Rating</label>
            <div class="d-flex">
              <div class="form-check me-3">
                <input
                  class="form-check-input"
                  type="radio"
                  value=""
                  formControlName="rating"
                  id="ratingAlle"
                  (click)="resetRating()"
                  [checked]="suchFormular.get('rating')?.value == null"
                />
                <label class="form-check-label" for="ratingAlle"> Alle </label>
              </div>
              <div class="form-check me-3" *ngFor="let r of [1,2,3,4,5]">
                <input
                  class="form-check-input"
                  type="radio"
                  [value]="r"
                  formControlName="rating"
                  id="rating{{r}}"
                />
                <label class="form-check-label" [for]="'rating' + r">
                  {{ r }} <span *ngIf="r === 1">Stern</span
                  ><span *ngIf="r > 1">Sterne</span>
                </label>
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-xl-4 d-flex align-items-center gap-2">
            <div class="form-check mb-0">
              <input
                class="form-check-input"
                type="checkbox"
                formControlName="lieferbar"
                id="lieferbar"
              />
              <label class="form-check-label" for="lieferbar"
                >Nur lieferbare Bücher</label
              >
            </div>
          </div>
          <div class="col-12 d-flex justify-content-end">
            <button type="submit" class="btn btn-primary" [disabled]="laden">
              <span
                *ngIf="laden"
                class="spinner-border spinner-border-sm me-2"
              ></span>
              Suchen
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div *ngIf="buecher.length > 0; else noData" class="mt-4">
    <table class="table table-striped table-hover border">
      <thead class="table-dark">
        <tr>
          <th>Titel</th>
          <th>Preis</th>
          <th>Rating</th>
          <th>Lieferbar</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let b of sichtbareBuecher">
          <td><strong>{{ b.titel?.titel }}</strong></td>
          <td>{{ b.preis | currency:'EUR':'symbol':'1.2-2' }}</td>
          <td>
            <span *ngFor="let star of [].constructor(b.rating || 0)">⭐</span>
          </td>
          <td>
            <span [class]="b.lieferbar ? 'text-success' : 'text-danger'">
              {{ b.lieferbar ? 'Ja' : 'Nein' }}
            </span>
          </td>
          <td>
            <button
              class="btn btn-sm btn-outline-info"
              (click)="detailsAnzeigen(b)"
            >
              Details
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <div
      class="d-flex justify-content-center"
      *ngIf="collectionSize > pageSize"
    >
      <ngb-pagination
        [collectionSize]="collectionSize"
        [(page)]="page"
        [pageSize]="pageSize"
        [maxSize]="5"
        [rotate]="true"
        [boundaryLinks]="true"
        (pageChange)="onPageChange($event)"
      ></ngb-pagination>
    </div>
  </div>

  <ng-template #noData>
    <div *ngIf="!laden" class="alert alert-info">Keine Bücher gefunden.</div>
  </ng-template>
</div>

<ng-template #detailModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title">Buch-Details</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    ></button>
  </div>
  <div class="modal-body" *ngIf="selectedBuch">
    <h5>Stammdaten</h5>
    <p><strong>ISBN:</strong> {{ selectedBuch.isbn }}</p>
    <p><strong>Titel:</strong> {{ selectedBuch.titel?.titel }}</p>
    <p>
      <strong>Preis:</strong> {{ selectedBuch.preis |
      currency:'EUR':'symbol':'1.2-2' }}
    </p>
    <p *ngIf="selectedBuch.art"><strong>Art:</strong> {{ selectedBuch.art }}</p>
    <p><strong>Rating:</strong> {{ selectedBuch.rating }} Sterne</p>
    <p>
      <strong>Lieferbar:</strong> {{ selectedBuch.lieferbar ? 'Ja' : 'Nein' }}
    </p>

    <h5 class="mt-3">Weitere Details</h5>
    <p *ngIf="selectedBuch.homepage">
      <strong>Homepage:</strong>
      <a [href]="selectedBuch.homepage" target="_blank"
        >{{ selectedBuch.homepage }}</a
      >
    </p>
    <p *ngIf="selectedBuch.rabatt !== undefined">
      <strong>Rabatt:</strong> {{ formatRabatt(selectedBuch.rabatt) }}
    </p>
    <p *ngIf="selectedBuch.schlagwoerter && selectedBuch.schlagwoerter.length">
      <strong>Tags:</strong>
      <span
        class="badge bg-secondary me-1"
        *ngFor="let tag of (selectedBuch.schlagwoerter || selectedBuch.tags || [])"
        >{{ tag }}</span
      >
    </p>
    <p *ngIf="selectedBuch.datum">
      <strong>Datum:</strong> {{ selectedBuch.datum | date:'medium' }}
    </p>
  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-secondary"
      (click)="modal.close('Close click')"
    >
      Schließen
    </button>
  </div>
</ng-template>
